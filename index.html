import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, getDoc, deleteDoc } from 'firebase/firestore';

// Funzione per riprodurre un suono
const playSound = (src, volume = 0.5) => {
  const audio = new Audio(src);
  audio.volume = volume;
  audio.play().catch(e => console.error("Errore nella riproduzione audio:", e));
};

// Componente per le barre di stato
const StatusBar = ({ label, value, colorClass }) => (
  <div className="mb-2 w-full">
    <div className="flex justify-between items-center mb-1">
      <span className="text-sm font-medium text-gray-700">{label}</span>
      <span className="text-sm font-medium text-gray-900">{Math.round(value)}%</span>
    </div>
    <div className="w-full bg-gray-200 rounded-full h-3">
      <div
        className={`h-3 rounded-full transition-all duration-300 ${colorClass}`}
        style={{ width: `${value}%` }}
      ></div>
    </div>
  </div>
);

// Componente Modale generico
const Modal = ({ show, onClose, title, children, showCloseButton = true }) => {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative">
        <h2 className="text-2xl font-bold mb-4 text-gray-800">{title}</h2>
        {children}
        {showCloseButton && (
          <button
            onClick={onClose}
            className="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold"
            aria-label="Chiudi"
          >
            &times;
          </button>
        )}
      </div>
    </div>
  );
};

// Componente Farmacia
const PharmacyModal = ({ show, onClose, money, onBuy, onMessage }) => {
  const products = [
    { name: 'Cerotto', price: 1, heal: 5, description: 'Cura piccole ferite' },
    { name: 'Antidolorifico', price: 5, heal: 20, description: 'Allevia il dolore' },
    { name: 'Kit Primo Soccorso', price: 15, heal: 50, description: 'Per emergenze mediche' },
    { name: 'Visita Medica', price: 50, heal: 100, description: 'Visita completa dal dottore' },
  ];

  return (
    <Modal show={show} onClose={onClose} title="Farmacia">
      <p className="mb-4 text-gray-700">Denaro disponibile: <span className="font-semibold text-green-600">‚Ç¨{money.toFixed(2)}</span></p>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {products.map((product) => (
          <div key={product.name} className="bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200">
            <h3 className="font-semibold text-lg mb-1">{product.name}</h3>
            <p className="text-sm text-gray-600 mb-2">{product.description}</p>
            <p className="text-base text-gray-800">Costo: <span className="font-bold">‚Ç¨{product.price.toFixed(2)}</span> | Cura: <span className="font-bold">{product.heal}%</span></p>
            <button
              onClick={() => onBuy(product, 'pharmacy')}
              disabled={money < product.price}
              className="mt-3 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Acquista
            </button>
          </div>
        ))}
      </div>
    </Modal>
  );
};

// Componente Supermercato
const SupermarketModal = ({ show, onClose, money, onBuyFood, onMessage }) => {
  const [selectedCategory, setSelectedCategory] = useState('all');

  const foodItems = [
    // Category: Acqua & Bibite
    { category: 'acqua_bibite', name: 'Acqua Naturale - EcoGoccia (1.5L)', price: 0.30, restore: 2, description: 'Acqua minerale economica.' },
    { category: 'acqua_bibite', name: 'Acqua Frizzante - BolleVivo (1L)', price: 0.50, restore: 2, description: 'Acqua frizzante rinfrescante.' },
    { category: 'acqua_bibite', name: 'Succo di Frutta Arancia - SolAgro (1L)', price: 1.80, restore: 8, description: 'Succo di frutta base.' },
    { category: 'acqua_bibite', name: 'Bibita Gassata Cola - HappyFizz (0.5L)', price: 1.20, restore: 5, description: 'Bibita zuccherata.' },
    { category: 'acqua_bibite', name: 'Bevanda Energetica - TurboCharge (0.33L)', price: 2.50, restore: 10, description: 'Per una carica extra.' },
    { category: 'acqua_bibite', name: 'Acqua Essenziale - VitalityAqua (1L)', price: 1.20, restore: 3, description: 'Acqua premium con minerali.' },

    // Category: Cibo Base
    { category: 'cibo_base', name: 'Pane Casereccio - AnticoForno', price: 2.50, restore: 20, description: 'Pane artigianale.' },
    { category: 'cibo_base', name: 'Pasta Lunga Integrale - BioGrano', price: 1.80, restore: 18, description: 'Pasta sana e nutriente.' },
    { category: 'cibo_base', name: 'Riso Basmati - ParadisoOrientale', price: 2.20, restore: 15, description: 'Riso aromatico.' },
    { category: 'cibo_base', name: 'Uova Fresche (12) - NaturaViva', price: 3.50, restore: 25, description: 'Uova fresche di fattoria.' },
    { category: 'cibo_base', name: 'Latte Biologico - MuccaFelice (1L)', price: 1.80, restore: 12, description: 'Latte da agricoltura biologica.' },
    { category: 'cibo_base', name: 'Pane a fette - Spuntino', price: 1.00, restore: 10, description: 'Per toast veloci.' },
    { category: 'cibo_base', name: 'Pasta Secca - La Nonna', price: 1.00, restore: 12, description: 'Formato classico.' },

    // Category: Carne & Pesce
    { category: 'carne_pesce', name: 'Petto di Pollo - FattoriaSana (500g)', price: 7.00, restore: 40, description: 'Fonte proteica magra.' },
    { category: 'carne_pesce', name: 'Carne Macinata - GustoGenuino (400g)', price: 5.50, restore: 30, description: 'Per rag√π o polpette.' },
    { category: 'carne_pesce', name: 'Merluzzo Fresco - BluProfondo (300g)', price: 9.00, restore: 35, description: 'Pesce bianco leggero.' },
    { category: 'carne_pesce', name: 'Salmone Fresco - Acquamarina (200g)', price: 14.00, restore: 50, description: 'Ricco di Omega-3.' },

    // Category: Latticini & Formaggi
    { category: 'latticini_formaggi', name: 'Yogurt Greco - BiancoPerfetto (250g)', price: 1.50, restore: 10, description: 'Ricco di proteine.' },
    { category: 'latticini_formaggi', name: 'Mozzarella di Bufala - OroBianco (250g)', price: 3.80, restore: 15, description: 'Fresca e saporita.' },
    { category: 'latticini_formaggi', name: 'Grana Padano DOP - StagioneOro (200g)', price: 7.00, restore: 20, description: 'Formaggio stagionato.' },
    { category: 'latticini_formaggi', name: 'Burro Fresco - PannaDelicata (125g)', price: 2.20, restore: 5, description: 'Per cucinare o spalmare.' },

    // Category: Frutta & Verdura
    { category: 'frutta_verdura', name: 'Mele (1kg) - RaccoltaFelicita', price: 2.00, restore: 10, description: 'Mele croccanti.' },
    { category: 'frutta_verdura', name: 'Banane (1kg) - TropicoSapore', price: 1.50, restore: 8, description: 'Ricche di potassio.' },
    { category: 'frutta_verdura', name: 'Insalata Mista - VerdeFreschezza', price: 1.20, restore: 5, description: 'Pronta da gustare.' },
    { category: 'frutta_verdura', name: 'Pomodori (500g) - SoleRosso', price: 1.80, restore: 7, description: 'Essenziali per la cucina italiana.' },

    // Category: Snack & Dolci
    { category: 'snack_dolci', name: 'Patatine Fritte - CroccanteMania (150g)', price: 1.80, restore: 8, description: 'Snack salato.' },
    { category: 'snack_dolci', name: 'Biscotti al Cioccolato - DeliziaNera (200g)', price: 3.00, restore: 12, description: 'Per i pi√π golosi.' },
    { category: 'snack_dolci', name: 'Gelato Artigianale - DolceMomento (500g)', price: 4.50, restore: 15, description: 'Un piacere rinfrescante.' },
    { category: 'snack_dolci', name: 'Barretta Cereali - EnergiaFit', price: 1.00, restore: 5, description: 'Snack veloce e salutare.' },
    { category: 'snack_dolci', name: 'Caramelle Miste - ZuccheroMagia', price: 1.50, restore: 3, description: 'Piccolo sfizio.' },
  ];

  const categories = [
    { id: 'all', name: 'Tutti i prodotti' },
    { id: 'acqua_bibite', name: 'Acqua & Bibite' },
    { id: 'cibo_base', name: 'Cibo Base' },
    { id: 'carne_pesce', name: 'Carne & Pesce' },
    { id: 'latticini_formaggi', name: 'Latticini & Formaggi' },
    { id: 'frutta_verdura', name: 'Frutta & Verdura' },
    { id: 'snack_dolci', name: 'Snack & Dolci' },
  ];

  const filteredItems = selectedCategory === 'all'
    ? foodItems
    : foodItems.filter(item => item.category === selectedCategory);

  return (
    <Modal show={show} onClose={onClose} title="Supermercato">
      <p className="mb-4 text-gray-700">Denaro disponibile: <span className="font-semibold text-green-600">‚Ç¨{money.toFixed(2)}</span></p>

      <div className="flex flex-wrap gap-2 mb-4">
        {categories.map((cat) => (
          <button
            key={cat.id}
            onClick={() => setSelectedCategory(cat.id)}
            className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
              selectedCategory === cat.id
                ? 'bg-green-600 text-white shadow-md'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`}
          >
            {cat.name}
          </button>
        ))}
      </div>

      <h3 className="text-xl font-bold mb-3 text-gray-800">Acquista Cibo ({categories.find(c => c.id === selectedCategory).name})</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 max-h-96 overflow-y-auto pr-2"> {/* Aggiunto max-h e overflow per lo scroll */}
        {filteredItems.length === 0 ? (
          <p className="col-span-full text-gray-600">Nessun prodotto in questa categoria.</p>
        ) : (
          filteredItems.map((item) => (
            <div key={item.name} className="bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200">
              <h4 className="font-semibold text-lg mb-1">{item.name}</h4>
              <p className="text-sm text-gray-600 mb-2">{item.description}</p>
              <p className="text-base text-gray-800">Costo: <span className="font-bold">‚Ç¨{item.price.toFixed(2)}</span> | Ripristina: <span className="font-bold">{item.restore}%</span></p>
              <button
                onClick={() => onBuyFood(item, 'supermarket')}
                disabled={money < item.price}
                className="mt-3 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Acquista
              </button>
            </div>
          ))
        )}
      </div>
    </Modal>
  );
};

// Componente Frigorifero
const FridgeModal = ({ show, onClose, fridge, onEatFood, onMessage }) => {
  return (
    <Modal show={show} onClose={onClose} title="Il Tuo Frigorifero">
      {fridge.length === 0 ? (
        <p className="text-gray-600">Il frigorifero √® vuoto. Compra qualcosa al supermercato!</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2">
          {fridge.map((item, index) => (
            <div key={index} className="bg-blue-50 p-4 rounded-md shadow-sm border border-blue-200">
              <h4 className="font-semibold text-lg mb-1">{item.name}</h4>
              <p className="text-sm text-gray-600 mb-2">Ripristina: <span className="font-bold">{item.restore}%</span></p>
              <button
                onClick={() => onEatFood(index)}
                className="mt-3 w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 transition-colors"
              >
                Mangia
              </button>
            </div>
          ))}
        </div>
      )}
    </Modal>
  );
};


// Componente Computer
const ComputerModal = ({ show, onClose, money, onPlayGame, internetUsage, onMessage }) => {
  const games = [
    { name: 'Scacchi', mb: 5, description: 'Un gioco di strategia, basso consumo.' },
    { name: 'Navigazione Web', mb: 20, description: 'Naviga su internet, consumo medio.' },
    { name: 'Videogame Online', mb: 50, description: 'Gioca online con amici, consumo elevato.' },
    { name: 'Streaming Video', mb: 100, description: 'Guarda film e serie, consumo molto elevato.' },
  ];
  const costPerMB = 0.01; // ‚Ç¨0.01 per MB

  return (
    <Modal show={show} onClose={onClose} title="Computer e Internet">
      <p className="mb-4 text-gray-700">Denaro disponibile: <span className="font-semibold text-green-600">‚Ç¨{money.toFixed(2)}</span></p>
      <p className="mb-4 text-gray-700">Consumo internet attuale: <span className="font-semibold text-red-600">{internetUsage.toFixed(2)} MB</span></p>
      <p className="mb-6 text-gray-700">Costo stimato bolletta: <span className="font-semibold text-red-600">‚Ç¨{(internetUsage * costPerMB).toFixed(2)}</span></p>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {games.map((game) => (
          <div key={game.name} className="bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200">
            <h3 className="font-semibold text-lg mb-1">{game.name}</h3>
            <p className="text-sm text-gray-600 mb-2">{game.description}</p>
            <p className="text-base text-gray-800">Consumo: <span className="font-bold">{game.mb} MB/ora</span></p>
            <button
              onClick={() => onPlayGame(game)}
              className="mt-3 w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors"
            >
              Gioca per 1 ora
            </button>
          </div>
        ))}
      </div>
    </Modal>
  );
};

// Componente Tempo Libero
const LeisureModal = ({ show, onClose, money, onDoLeisure, onMessage }) => {
  const activities = [
    { name: 'Passeggiata al parco', price: 0, restoreEnergy: 5, description: 'Una boccata d\'aria fresca.' },
    { name: 'Leggere un libro', price: 0, restoreEnergy: 10, description: 'Relax per la mente.' },
    { name: 'Guardare un film', price: 8, restoreEnergy: 20, description: 'Una serata al cinema.' },
    { name: 'Cena al ristorante', price: 30, restoreEnergy: 30, restoreFood: 20, description: 'Un pasto fuori casa.' },
    { name: 'Concerto', price: 50, restoreEnergy: 40, description: 'Musica dal vivo.' },
  ];

  return (
    <Modal show={show} onClose={onClose} title="Tempo Libero">
      <p className="mb-4 text-gray-700">Denaro disponibile: <span className="font-semibold text-green-600">‚Ç¨{money.toFixed(2)}</span></p>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {activities.map((activity) => (
          <div key={activity.name} className="bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200">
            <h3 className="font-semibold text-lg mb-1">{activity.name}</h3>
            <p className="text-sm text-gray-600 mb-2">{activity.description}</p>
            <p className="text-base text-gray-800">Costo: <span className="font-bold">‚Ç¨{activity.price.toFixed(2)}</span></p>
            <p className="text-base text-gray-800">Energia: <span className="font-bold">+{activity.restoreEnergy}%</span> {activity.restoreFood ? ` | Cibo: +${activity.restoreFood}%` : ''}</p>
            <button
              onClick={() => onDoLeisure(activity)}
              disabled={money < activity.price}
              className="mt-3 w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Fai questa attivit√†
            </button>
          </div>
        ))}
      </div>
    </Modal>
  );
};

// Componente Modale per l'input del nome del personaggio
const NameInputModal = ({ show, onNameSubmit, message, isCheckingName }) => {
  const [name, setName] = useState('');

  const handleSubmit = () => {
    if (name.trim()) {
      onNameSubmit(name.trim());
    }
  };

  return (
    <Modal show={show} onClose={() => {}} title="Dai un nome al tuo personaggio" showCloseButton={false}>
      <p className="mb-4 text-gray-700">Scegli un nome per il tuo personaggio. Sar√† memorizzato per le tue partite future.</p>
      <input
        type="text"
        value={name}
        onChange={(e) => setName(e.target.value)}
        placeholder="Nome del personaggio"
        className="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-blue-500 focus:border-blue-500"
        disabled={isCheckingName}
      />
      {message && (
        <p className={`text-sm mb-4 ${message.includes('Errore') || message.includes('gi√† registrato') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>
      )}
      <button
        onClick={handleSubmit}
        disabled={!name.trim() || isCheckingName}
        className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isCheckingName ? 'Verifica nome...' : 'Conferma Nome'}
      </button>
    </Modal>
  );
};

// Componente per la Cronologia Acquisti / Scontrini
const ReceiptHistoryModal = ({ show, onClose, purchaseHistory }) => {
  // Raggruppa gli acquisti per data per simulare scontrini giornalieri
  const groupedPurchases = purchaseHistory.reduce((acc, purchase) => {
    const date = new Date(purchase.timestamp).toLocaleDateString('it-IT');
    if (!acc[date]) {
      acc[date] = [];
    }
    acc[date].push(purchase);
    return acc;
  }, {});

  return (
    <Modal show={show} onClose={onClose} title="Cronologia Acquisti / Scontrini">
      {Object.keys(groupedPurchases).length === 0 ? (
        <p className="text-gray-600">Nessun acquisto registrato.</p>
      ) : (
        <div className="max-h-96 overflow-y-auto pr-2">
          {Object.keys(groupedPurchases).sort((a, b) => new Date(b) - new Date(a)).map(date => (
            <div key={date} className="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
              <h3 className="text-xl font-bold mb-3 text-gray-800 border-b pb-2">Scontrino del {date}</h3>
              <ul className="list-disc pl-5">
                {groupedPurchases[date].map((purchase, index) => (
                  <li key={index} className="text-gray-700 text-sm mb-1">
                    <span className="font-semibold">{purchase.item.name}</span> - ‚Ç¨{purchase.item.price.toFixed(2)} ({purchase.type === 'pharmacy' ? 'Farmacia' : 'Supermercato'})
                  </li>
                ))}
              </ul>
              <p className="text-right font-bold text-gray-900 mt-2">
                Totale: ‚Ç¨{groupedPurchases[date].reduce((sum, p) => sum + p.item.price, 0).toFixed(2)}
              </p>
            </div>
          ))}
        </div>
      )}
    </Modal>
  );
};


const App = () => {
  const [app, setApp] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false); // Stato per indicare che l'autenticazione √® pronta

  // Stato del gioco
  const [characterName, setCharacterName] = useState(null);
  const [money, setMoney] = useState(5.00);
  const [health, setHealth] = useState(100);
  const [food, setFood] = useState(100);
  const [energy, setEnergy] = useState(100);
  const [fridge, setFridge] = useState([]);
  const [internetUsage, setInternetUsage] = useState(0);
  const [gameDay, setGameDay] = useState(1); // Giorno di gioco
  const [lastSalaryDay, setLastSalaryDay] = useState(0); // Ultimo giorno di gioco in cui √® stato ricevuto lo stipendio
  const [lastSavedRealTime, setLastSavedRealTime] = useState(Date.now()); // Timestamp dell'ultimo salvataggio (tempo reale)
  const [purchaseHistory, setPurchaseHistory] = useState([]); // Cronologia acquisti per scontrini

  const [message, setMessage] = useState('');
  const messageTimeoutRef = useRef(null); // Riferimento per il timeout del messaggio

  // Stato modali
  const [showPharmacy, setShowPharmacy] = useState(false);
  const [showSupermarket, setShowSupermarket] = useState(false);
  const [showFridge, setShowFridge] = useState(false); // Nuova modale per il frigorifero
  const [showComputer, setShowComputer] = useState(false);
  const [showLeisure, setShowLeisure] = useState(false); // Modale per Tempo Libero
  const [showFinancialAdvice, setShowFinancialAdvice] = useState(false); // Modale per consigli finanziari
  const [financialAdvice, setFinancialAdvice] = useState('Clicca per ricevere un consiglio...');
  const [isGeneratingAdvice, setIsGeneratingAdvice] = useState(false);
  const [showGameOver, setShowGameOver] = useState(false);
  const [showNameInputModal, setShowNameInputModal] = useState(true); // Mostra all'inizio
  const [nameInputMessage, setNameInputMessage] = useState('');
  const [isCheckingName, setIsCheckingName] = useState(false);
  const [showReceiptHistory, setShowReceiptHistory] = useState(false); // Nuova modale per la cronologia scontrini


  // Constants
  const GAME_TICK_INTERVAL_MS = 1000; // Ogni 1 secondo reale
  const GAME_MINUTES_PER_REAL_SECOND = 12; // 1 secondo reale = 12 minuti di gioco
  const DAILY_SALARY_AMOUNT = 50; // Euro
  const MINUTES_IN_A_GAME_DAY = 24 * 60; // Minuti in un giorno di gioco

  const HEALTH_DECREASE_PER_HOUR = 1; // 1% ogni ora di gioco
  const FOOD_DECREASE_PER_5_MINUTES = 1; // 1% ogni 5 minuti di gioco
  const ENERGY_DECREASE_PER_20_MINUTES = 1; // 1% ogni 20 minuti di gioco

  const MONTHLY_TAX = 200; // Euro (semplificato) - Verr√† applicato ogni X giorni di gioco
  const DAYS_PER_MONTH_FOR_TAX = 30; // Ogni 30 giorni di gioco si pagano le tasse

  const GAME_OVER_DEBT_LIMIT = -2000;

  // Riferimento per il debouncing del salvataggio su Firestore
  const saveTimeoutRef = useRef(null);

  // Sound URLs
  const SCAN_SOUND = 'https://actions.google.com/sounds/v1/ui/beep_short.ogg';
  const RECEIPT_PRINT_SOUND = 'https://actions.google.com/sounds/v1/commercial/cash_register_printer.ogg';

  // Funzione per mostrare messaggi
  const displayMessage = useCallback((msg, duration = 3000) => {
    setMessage(msg);
    if (messageTimeoutRef.current) {
      clearTimeout(messageTimeoutRef.current);
    }
    messageTimeoutRef.current = setTimeout(() => {
      setMessage('');
    }, duration);
  }, []);


  // --- Firebase Initialization and Auth ---
  useEffect(() => {
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    try {
      const firebaseApp = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(firebaseApp);
      const firebaseAuth = getAuth(firebaseApp);

      setApp(firebaseApp);
      setDb(firestoreDb);
      setAuth(firebaseAuth);

      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      const authenticate = (token) => {
        if (token) {
          return signInWithCustomToken(firebaseAuth, token);
        } else {
          return signInAnonymously(firebaseAuth);
        }
      };

      authenticate(initialAuthToken)
        .then((userCredential) => {
          setUserId(userCredential.user.uid);
          setIsAuthReady(true);
          console.log("Autenticato:", userCredential.user.uid);
        })
        .catch((error) => {
          console.error("Errore autenticazione iniziale:", error);
          // Tentativo di autenticazione anonima come fallback in caso di errore token custom
          signInAnonymously(firebaseAuth)
            .then((userCredential) => {
              setUserId(userCredential.user.uid);
              setIsAuthReady(true);
              console.log("Autenticato anonimamente (fallback):", userCredential.user.uid);
            })
            .catch((anonError) => {
              console.error("Errore autenticazione anonima:", anonError);
              setIsAuthReady(true); // Continua anche senza autenticazione
            });
        });

      onAuthStateChanged(firebaseAuth, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          // If user logs out or session expires, clear userId
          setUserId(null);
          setCharacterName(null); // Clear character name
          setShowNameInputModal(true); // Re-show name input for new session
        }
        setIsAuthReady(true);
      });

    } catch (error) {
      console.error("Errore nell'inizializzazione di Firebase:", error);
      setIsAuthReady(true); // Permetti all'app di avviarsi anche se Firebase fallisce
    }
  }, []);

  // Funzione per salvare lo stato del gioco
  const saveGameState = useCallback(async () => {
    if (!db || !userId || !characterName) {
      // Non salvare se Firebase non √® pronto, userId non c'√® o il nome del personaggio non √® impostato
      return;
    }

    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
    }

    saveTimeoutRef.current = setTimeout(async () => {
      const gameStateRef = doc(db, `artifacts/${__app_id}/users/${userId}/game_state`, 'current_game');
      try {
        await setDoc(gameStateRef, {
          characterName,
          money,
          health,
          food,
          energy,
          fridge: JSON.stringify(fridge), // Serializza array di oggetti
          internetUsage,
          gameDay,
          lastSalaryDay,
          lastSavedRealTime: Date.now(), // Aggiorna il timestamp reale dell'ultimo salvataggio
          purchaseHistory: JSON.stringify(purchaseHistory), // Salva la cronologia acquisti
        });
        // console.log("Stato del gioco salvato con successo.");
      } catch (e) {
        console.error("Errore nel salvataggio dello stato del gioco:", e);
      }
    }, 500); // Salva dopo 500ms di inattivit√†
  }, [db, userId, characterName, money, health, food, energy, fridge, internetUsage, gameDay, lastSalaryDay, purchaseHistory]);

  // Listener per caricare lo stato del gioco all'avvio o al cambio utente
  useEffect(() => {
    if (db && userId && isAuthReady) {
      const gameStateRef = doc(db, `artifacts/${__app_id}/users/${userId}/game_state`, 'current_game');
      const unsubscribe = onSnapshot(gameStateRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          setCharacterName(data.characterName || null);
          setMoney(data.money !== undefined ? data.money : 5.00);
          setHealth(data.health !== undefined ? data.health : 100);
          setFood(data.food !== undefined ? data.food : 100);
          setEnergy(data.energy !== undefined ? data.energy : 100);
          try {
            setFridge(data.fridge ? JSON.parse(data.fridge) : []);
          } catch (e) {
            console.error("Errore nel parsing del frigorifero:", e);
            setFridge([]);
          }
          setInternetUsage(data.internetUsage !== undefined ? data.internetUsage : 0);
          setGameDay(data.gameDay !== undefined ? data.gameDay : 1);
          setLastSalaryDay(data.lastSalaryDay !== undefined ? data.lastSalaryDay : 0);
          setLastSavedRealTime(data.lastSavedRealTime !== undefined ? data.lastSavedRealTime : Date.now());
          try {
            setPurchaseHistory(data.purchaseHistory ? JSON.parse(data.purchaseHistory) : []);
          } catch (e) {
            console.error("Errore nel parsing della cronologia acquisti:", e);
            setPurchaseHistory([]);
          }

          console.log("Stato del gioco caricato con successo.");

          // Se characterName √® presente, nascondi il modal del nome
          if (data.characterName) {
            setShowNameInputModal(false);
          } else {
            setShowNameInputModal(true);
          }

          // Calcola il tempo offline e applica le penalit√† e stipendi
          const currentTime = Date.now();
          const offlineDurationMs = currentTime - (data.lastSavedRealTime || currentTime);
          const offlineGameMinutes = (offlineDurationMs / 1000) * GAME_MINUTES_PER_REAL_SECOND; // Minuti di gioco trascorsi offline

          let newHealth = data.health;
          let newFood = data.food;
          let newEnergy = data.energy;
          let newMoney = data.money;
          let newGameDay = data.gameDay;
          let newLastSalaryDay = data.lastSalaryDay;

          if (offlineGameMinutes > 0) {
            // Applicare i decrementi delle barre per il tempo offline
            newHealth = Math.max(0, newHealth - (offlineGameMinutes / 60) * HEALTH_DECREASE_PER_HOUR);
            newFood = Math.max(0, newFood - (offlineGameMinutes / 5) * FOOD_DECREASE_PER_5_MINUTES);
            newEnergy = Math.max(0, newEnergy - (offlineGameMinutes / 20) * ENERGY_DECREASE_PER_20_MINUTES);

            // Calcolare giorni di gioco passati offline
            const daysPassedOffline = Math.floor(offlineGameMinutes / MINUTES_IN_A_GAME_DAY);
            if (daysPassedOffline > 0) {
              newGameDay = data.gameDay + daysPassedOffline;
            }

            // Applicare stipendi per i giorni passati offline (il giorno dopo)
            let daysForSalary = newGameDay - newLastSalaryDay - 1; // -1 perch√© lo stipendio √® per il giorno *precedente*
            if (daysForSalary > 0) {
              newMoney += daysForSalary * DAILY_SALARY_AMOUNT;
              newLastSalaryDay = newGameDay -1 ; // l'ultimo giorno di paga √® ieri
              displayMessage(`Hai ricevuto ‚Ç¨${(daysForSalary * DAILY_SALARY_AMOUNT).toFixed(2)} di stipendi arretrati per ${daysForSalary} giorni offline.`, 5000);
            }

            // Aggiorna lo stato del gioco con le penalit√† e gli stipendi offline
            setHealth(newHealth);
            setFood(newFood);
            setEnergy(newEnergy);
            setMoney(newMoney);
            setGameDay(newGameDay);
            setLastSalaryDay(newLastSalaryDay);
            displayMessage(`Hai perso salute, cibo ed energia mentre eri offline, ma hai ricevuto gli stipendi arretrati!`, 7000);
          }


        } else {
          console.log("Nessuno stato di gioco salvato, inizio una nuova partita.");
          // Se non c'√® stato salvato, assicurati che il modal del nome sia visibile
          setShowNameInputModal(true);
          setMoney(5.00);
          setHealth(100);
          setFood(100);
          setEnergy(100);
          setFridge([]);
          setInternetUsage(0);
          setGameDay(1);
          setLastSalaryDay(0); // Inizio, non ha ancora ricevuto stipendi
          setLastSavedRealTime(Date.now());
          setPurchaseHistory([]);
        }
      }, (error) => {
        console.error("Errore nel caricamento dello stato del gioco:", error);
      });

      return () => unsubscribe(); // Cleanup listener
    }
  }, [db, userId, isAuthReady, displayMessage]);

  // Salva lo stato ogni volta che una variabile di stato chiave cambia
  useEffect(() => {
    if (isAuthReady && characterName) { // Assicurati che Firebase sia pronto e il nome personaggio impostato prima di salvare
      saveGameState();
    }
  }, [money, health, food, energy, fridge, internetUsage, gameDay, lastSalaryDay, characterName, purchaseHistory, isAuthReady, saveGameState]);


  // --- Gestione Nome Personaggio ---
  const handleNameSubmit = useCallback(async (name) => {
    if (!db || !userId) {
      setNameInputMessage("Errore: Servizi di gioco non disponibili.");
      return;
    }

    setIsCheckingName(true);
    setNameInputMessage("Controllo disponibilit√† nome...");

    const characterNamesRef = doc(db, `artifacts/${__app_id}/public/data/character_names`, name.toLowerCase());
    try {
      const docSnap = await getDoc(characterNamesRef);
      if (docSnap.exists()) {
        setNameInputMessage("Questo nome √® gi√† registrato. Scegline un altro.");
        playSound('https://actions.google.com/sounds/v1/ui/close_alert_long.ogg', 0.5); // Suono di errore
      } else {
        // Nome disponibile, registralo
        await setDoc(characterNamesRef, { userId: userId });
        setCharacterName(name);
        setShowNameInputModal(false);
        setNameInputMessage('');
        displayMessage(`Benvenuto, ${name}! La tua avventura inizia.`, 5000);
        playSound('https://actions.google.com/sounds/v1/ui/success_chime.ogg', 0.5); // Suono di successo
      }
    } catch (e) {
      console.error("Errore durante la verifica/registrazione del nome:", e);
      setNameInputMessage("Errore durante la registrazione del nome. Riprova.");
      playSound('https://actions.google.com/sounds/v1/ui/close_alert_long.ogg', 0.5); // Suono di errore
    } finally {
      setIsCheckingName(false);
    }
  }, [db, userId, displayMessage]);

  // --- Game Logic ---
  useEffect(() => {
    if (!isAuthReady || !characterName) return; // Attendi che autenticazione e nome personaggio siano pronti

    const gameInterval = setInterval(() => {
      let currentHealth = health;
      let currentFood = food;
      let currentEnergy = energy;
      let currentMoney = money;
      let currentGameDay = gameDay;
      let currentLastSalaryDay = lastSalaryDay;

      // Calcola i minuti di gioco passati in questo tick
      const gameMinutesInThisTick = GAME_MINUTES_PER_REAL_SECOND;

      // Decremento salute (1% ogni ora di gioco = 60 minuti di gioco)
      currentHealth = Math.max(0, currentHealth - (gameMinutesInThisTick / 60) * HEALTH_DECREASE_PER_HOUR);

      // Decremento cibo (1% ogni 5 minuti di gioco)
      currentFood = Math.max(0, currentFood - (gameMinutesInThisTick / 5) * FOOD_DECREASE_PER_5_MINUTES);

      // Decremento energia (1% ogni 20 minuti di gioco)
      currentEnergy = Math.max(0, currentEnergy - (gameMinutesInThisTick / 20) * ENERGY_DECREASE_PER_20_MINUTES);

      // Aggiornamento del giorno di gioco
      const newTotalGameMinutes = (currentGameDay - 1) * MINUTES_IN_A_GAME_DAY + gameMinutesInThisTick;
      const newCalculatedGameDay = Math.floor(newTotalGameMinutes / MINUTES_IN_A_GAME_DAY) + 1;

      if (newCalculatedGameDay > currentGameDay) {
        // Un nuovo giorno di gioco √® iniziato
        currentGameDay = newCalculatedGameDay;
        displayMessage(`√à il giorno ${currentGameDay} di gioco!`);

        // Stipendio giornaliero (ricevuto il giorno dopo per il giorno precedente)
        if (currentGameDay > currentLastSalaryDay + 1) { // Se √® passato almeno un giorno intero da quando √® stato pagato l'ultimo stipendio
          currentMoney += DAILY_SALARY_AMOUNT;
          currentLastSalaryDay = currentGameDay -1 ; // Lo stipendio √® per il giorno precedente
          displayMessage(`Hai ricevuto lo stipendio di ‚Ç¨${DAILY_SALARY_AMOUNT.toFixed(2)} per il Giorno ${currentLastSalaryDay}!`);
          playSound('https://actions.google.com/sounds/v1/commerce/cash_register.ogg');
        }

        // Tasse mensili (ogni 30 giorni di gioco)
        if (currentGameDay > 0 && currentGameDay % DAYS_PER_MONTH_FOR_TAX === 0) {
          currentMoney -= MONTHLY_TAX;
          displayMessage(`Hai pagato ‚Ç¨${MONTHLY_TAX.toFixed(2)} di tasse per questo mese!`);
          playSound('https://actions.google.com/sounds/v1/finance/cash_register_ding.ogg', 0.5); // Suono tasse
        }
      }

      setHealth(currentHealth);
      setFood(currentFood);
      setEnergy(currentEnergy);
      setMoney(currentMoney);
      setGameDay(currentGameDay);
      setLastSalaryDay(currentLastSalaryDay);

      // Check Game Over
      if (currentMoney <= GAME_OVER_DEBT_LIMIT && !showGameOver) {
        setShowGameOver(true);
        displayMessage("GAME OVER! Hai raggiunto un debito troppo elevato.", 999999);
        clearInterval(gameInterval); // Ferma il gioco
      }

    }, GAME_TICK_INTERVAL_MS);

    return () => clearInterval(gameInterval); // Pulizia all'unmount
  }, [health, food, energy, money, gameDay, lastSalaryDay, displayMessage, isAuthReady, characterName, showGameOver]);


  // --- Azioni del Giocatore ---

  const handleSleep = () => {
    if (energy === 100) {
      displayMessage("La barra dell'energia √® gi√† piena!", 2000);
      return;
    }
    setEnergy(100);
    displayMessage("Hai dormito e ricaricato l'energia!", 2000);
    playSound('https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing.ogg', 0.3); // Suono sveglia
  };

  const handleWork = () => {
    displayMessage("Stai lavorando... Lo stipendio di ‚Ç¨50 arriver√† il giorno dopo!", 3000);
    playSound('https://actions.google.com/sounds/v1/tools/saw_cutting_wood.ogg', 0.3); // Suono di lavoro
  };

  // Modificato per includere il tipo di acquisto e suoni
  const handleBuyProduct = (product, type) => {
    if (health === 100) {
      displayMessage("La barra della salute √® gi√† piena!", 2000);
      return;
    }
    if (money >= product.price) {
      playSound(SCAN_SOUND); // Suono scansione prodotto
      setTimeout(() => { // Ritarda il suono dello scontrino per effetto
        setMoney((prev) => prev - product.price);
        setHealth((prev) => Math.min(100, prev + product.heal));
        setPurchaseHistory((prev) => [...prev, { item: product, type: type, timestamp: Date.now() }]);
        displayMessage(`Hai comprato ${product.name}. Salute +${product.heal}%!`, 2000);
        playSound(RECEIPT_PRINT_SOUND); // Suono stampa scontrino
        setShowPharmacy(false); // Chiudi la modale
      }, 500); // Mezzo secondo di ritardo
    } else {
      displayMessage("Non hai abbastanza soldi per questo articolo!", 2000);
    }
  };

  // Modificato per includere il tipo di acquisto e suoni
  const handleBuyFood = (item, type) => {
    if (money >= item.price) {
      playSound(SCAN_SOUND); // Suono scansione prodotto
      setTimeout(() => { // Ritarda il suono dello scontrino per effetto
        setMoney((prev) => prev - item.price);
        setFridge((prev) => [...prev, item]); // Aggiungi al frigo
        setPurchaseHistory((prev) => [...prev, { item: item, type: type, timestamp: Date.now() }]);
        displayMessage(`Hai comprato ${item.name} e lo hai messo in frigo!`, 2000);
        playSound(RECEIPT_PRINT_SOUND); // Suono stampa scontrino
      }, 500); // Mezzo secondo di ritardo
    } else {
      displayMessage("Non hai abbastanza soldi per questo alimento!", 2000);
    }
  };

  const handleEatFood = (index) => {
    if (food === 100) {
      displayMessage("La barra del cibo √® gi√† piena!", 2000);
      return;
    }
    const itemToEat = fridge[index];
    setFood((prev) => Math.min(100, prev + itemToEat.restore));
    setFridge((prev) => prev.filter((_, i) => i !== index)); // Rimuovi dal frigo
    displayMessage(`Hai mangiato ${itemToEat.name}. Cibo +${itemToEat.restore}%!`, 2000);
    playSound('https://actions.google.com/sounds/v1/human_voices/eating_sound.ogg', 0.3); // Suono mangiare
  };

  const handlePlayGame = (game) => {
    setInternetUsage((prev) => prev + game.mb);
    displayMessage(`Hai giocato a ${game.name} per 1 ora. Consumo: ${game.mb} MB.`, 2000);
    playSound('https://actions.google.com/sounds/v1/cartoon/cartoon_success_fanfare.ogg', 0.3); // Suono gioco
  };

  const handleDoLeisure = (activity) => {
    if (money < activity.price) {
      displayMessage("Non hai abbastanza soldi per questa attivit√†!", 2000);
      return;
    }
    setMoney((prev) => prev - activity.price);
    setEnergy((prev) => Math.min(100, prev + (activity.restoreEnergy || 0)));
    setFood((prev) => Math.min(100, prev + (activity.restoreFood || 0))); // Per attivit√† che ripristinano anche cibo
    displayMessage(`Hai fatto: ${activity.name}! Energia +${activity.restoreEnergy || 0}%${activity.restoreFood ? ` e Cibo +${activity.restoreFood}%` : ''}.`, 2000);
    playSound('https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg', 0.3); // Suono generico per attivit√†
    setShowLeisure(false);
  };

  // Funzione per ottenere consigli finanziari dall'LLM
  const getFinancialAdvice = useCallback(async () => {
    setIsGeneratingAdvice(true);
    setFinancialAdvice('Sto pensando al miglior consiglio per te...');
    const prompt = `Sei un consulente finanziario. Analizza la seguente situazione di un personaggio in un gioco di simulazione di vita e fornisci un breve consiglio su come gestire meglio le sue risorse, in particolare sul risparmio o sulle spese.
    Situazione attuale:
    Denaro: ‚Ç¨${money.toFixed(2)}
    Salute: ${health}%
    Cibo: ${food}%
    Energia: ${energy}%
    Consumo Internet (mensile stimato): ‚Ç¨${(internetUsage * 0.01).toFixed(2)}

    Considera che lo stipendio giornaliero √® di ‚Ç¨${DAILY_SALARY_AMOUNT.toFixed(2)} e le tasse mensili sono di ‚Ç¨${MONTHLY_TAX.toFixed(2)} (ogni ${DAYS_PER_MONTH_FOR_TAX} giorni di gioco). Il limite di debito per il GAME OVER √® ‚Ç¨${GAME_OVER_DEBT_LIMIT.toFixed(2)}.

    Fornisci un consiglio pratico e incoraggiante, focalizzato sul risparmio e sulla gestione efficiente, in italiano. Sii conciso.`;

    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Lascia vuoto per l'API key fornita dall'ambiente
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setFinancialAdvice(text);
        playSound('https://actions.google.com/sounds/v1/ui/open_book.ogg', 0.5); // Suono per il consiglio
      } else {
        setFinancialAdvice("Non sono riuscito a generare un consiglio. Riprova pi√π tardi.");
        console.error("Risposta API inattesa:", result);
      }
    } catch (error) {
      setFinancialAdvice("Errore durante la richiesta di consiglio. Controlla la tua connessione.");
      console.error("Errore fetch API Gemini:", error);
    } finally {
      setIsGeneratingAdvice(false);
    }
  }, [money, health, food, energy, internetUsage, displayMessage]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-200 flex items-center justify-center p-4 font-sans antialiased text-gray-900">
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full border-4 border-indigo-300">
        <h1 className="text-4xl font-extrabold text-center mb-6 text-indigo-700">Simulazione di Vita</h1>

        {/* Modal per l'input del nome del personaggio */}
        <NameInputModal
          show={showNameInputModal}
          onNameSubmit={handleNameSubmit}
          message={nameInputMessage}
          isCheckingName={isCheckingName}
        />

        {!showNameInputModal && ( // Mostra il gioco solo se il nome √® stato impostato
          <>
            <p className="text-center text-xl font-semibold text-gray-700 mb-4">
              Personaggio: <span className="text-indigo-600">{characterName}</span>
            </p>
            {userId && (
              <p className="text-center text-sm text-gray-500 mb-4">
                ID Utente: <span className="font-mono text-gray-700 break-all">{userId}</span>
              </p>
            )}
            <p className="text-center text-md text-gray-600 mb-4">
              Giorno di Gioco: <span className="font-bold text-gray-800">{gameDay}</span>
            </p>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div className="flex flex-col items-center justify-center bg-yellow-50 p-4 rounded-lg shadow-inner">
                <span className="text-5xl mb-2" role="img" aria-label="Soldi">üí∞</span>
                <p className="text-3xl font-bold text-green-700">‚Ç¨{money.toFixed(2)}</p>
              </div>
              <div className="space-y-4">
                <StatusBar label="Salute" value={health} colorClass="bg-red-500" />
                <StatusBar label="Cibo" value={food} colorClass="bg-green-500" />
                <StatusBar label="Energia" value={energy} colorClass="bg-blue-500" />
              </div>
            </div>

            {message && (
              <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-6 text-center shadow-md">
                <p className="font-medium">{message}</p>
              </div>
            )}

            {showGameOver && (
              <div className="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 p-4">
                <div className="bg-red-700 text-white rounded-lg shadow-xl p-8 text-center animate-pulse">
                  <h2 className="text-5xl font-extrabold mb-4">GAME OVER!</h2>
                  <p className="text-2xl mb-6">Hai raggiunto un debito di ‚Ç¨{money.toFixed(2)}.</p>
                  <button
                    onClick={() => window.location.reload()} // Riavvia il gioco
                    className="bg-white text-red-700 py-3 px-8 rounded-full text-xl font-bold hover:bg-gray-200 transition-colors shadow-lg"
                  >
                    Ricomincia
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <button
                onClick={handleSleep}
                className="flex flex-col items-center justify-center p-4 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üò¥</span>
                <span className="font-semibold text-lg">Dormi</span>
              </button>
              <button
                onClick={() => setShowPharmacy(true)}
                className="flex flex-col items-center justify-center p-4 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üè•</span>
                <span className="font-semibold text-lg">Farmacia</span>
              </button>
              <button
                onClick={() => setShowSupermarket(true)}
                className="flex flex-col items-center justify-center p-4 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üõí</span>
                <span className="font-semibold text-lg">Supermercato</span>
              </button>
              <button
                onClick={() => setShowFridge(true)} // Nuovo pulsante per il frigorifero
                className="flex flex-col items-center justify-center p-4 bg-yellow-700 text-white rounded-lg shadow-md hover:bg-yellow-800 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üßä</span>
                <span className="font-semibold text-lg">Frigorifero</span>
              </button>
              <button
                onClick={handleWork}
                className="flex flex-col items-center justify-center p-4 bg-yellow-500 text-gray-800 rounded-lg shadow-md hover:bg-yellow-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üíº</span>
                <span className="font-semibold text-lg">Lavora</span>
              </button>
              <button
                onClick={() => setShowComputer(true)}
                className="flex flex-col items-center justify-center p-4 bg-purple-500 text-white rounded-lg shadow-md hover:bg-purple-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üíª</span>
                <span className="font-semibold text-lg">Computer</span>
              </button>
              {/* Pulsante per Tempo Libero */}
              <button
                onClick={() => setShowLeisure(true)}
                className="flex flex-col items-center justify-center p-4 bg-orange-500 text-white rounded-lg shadow-md hover:bg-orange-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üé≠</span>
                <span className="font-semibold text-lg">Tempo Libero</span>
              </button>
              {/* Pulsante per Consigli Finanziari */}
              <button
                onClick={() => setShowFinancialAdvice(true)}
                className="flex flex-col items-center justify-center p-4 bg-teal-500 text-white rounded-lg shadow-md hover:bg-teal-600 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">‚ú®</span>
                <span className="font-semibold text-lg">Consigli Finanziari</span>
              </button>
              {/* Nuovo pulsante per la cronologia acquisti */}
              <button
                onClick={() => setShowReceiptHistory(true)}
                className="flex flex-col items-center justify-center p-4 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition-transform transform hover:scale-105 active:scale-95"
              >
                <span className="text-4xl mb-2">üßæ</span>
                <span className="font-semibold text-lg">Cronologia Acquisti</span>
              </button>
            </div>

            <PharmacyModal
              show={showPharmacy}
              onClose={() => setShowPharmacy(false)}
              money={money}
              onBuy={handleBuyProduct}
              onMessage={displayMessage}
            />
            <SupermarketModal
              show={showSupermarket}
              onClose={() => setShowSupermarket(false)}
              money={money}
              onBuyFood={handleBuyFood}
              onMessage={displayMessage}
            />
            <FridgeModal
              show={showFridge}
              onClose={() => setShowFridge(false)}
              fridge={fridge}
              onEatFood={handleEatFood}
              onMessage={displayMessage}
            />
            <ComputerModal
              show={showComputer}
              onClose={() => setShowComputer(false)}
              money={money}
              onPlayGame={handlePlayGame}
              internetUsage={internetUsage}
              onMessage={displayMessage}
            />
            <LeisureModal
              show={showLeisure}
              onClose={() => setShowLeisure(false)}
              money={money}
              onDoLeisure={handleDoLeisure}
              onMessage={displayMessage}
            />

            {/* Modale per Consigli Finanziari */}
            <Modal show={showFinancialAdvice} onClose={() => setShowFinancialAdvice(false)} title="Consigli Finanziari">
              <p className="text-gray-700 text-lg mb-4">
                {isGeneratingAdvice ? (
                  <span className="text-blue-600 animate-pulse">{financialAdvice}</span>
                ) : (
                  financialAdvice
                )}
              </p>
              <button
                onClick={getFinancialAdvice}
                disabled={isGeneratingAdvice}
                className="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isGeneratingAdvice ? 'Generazione in corso...' : 'Chiedi un consiglio a Gemini'}
              </button>
            </Modal>

            {/* Modale per la Cronologia Acquisti / Scontrini */}
            <ReceiptHistoryModal
              show={showReceiptHistory}
              onClose={() => setShowReceiptHistory(false)}
              purchaseHistory={purchaseHistory}
            />
          </>
        )}
      </div>
    </div>
  );
};

export default App;
